<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pirandello ‚Äî La visione del mondo</title>
  <style>
    :root{
      --bg:#0f141a;
      --paper:#ffffff;
      --ink:#12161c;
      --muted:#5b6676;
      --shadow: 0 14px 40px rgba(0,0,0,.28);
      --radius: 18px;
      --accent:#2b7cff;
      --danger:#ff4d4d;
      --ok:#39d98a;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1100px 800px at 20% 10%, rgba(43,124,255,.18), transparent 60%),
                  radial-gradient(1100px 800px at 85% 15%, rgba(139,92,246,.18), transparent 55%),
                  var(--bg);
      color:#e8edf5;
      font-family: var(--sans);
    }

    .app{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px;
      box-sizing: border-box;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
      min-height: 100%;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .brand{display:flex; flex-direction:column; line-height:1.1;}
    .brand strong{font-size:14px;}
    .brand span{font-size:12px; color: rgba(232,237,245,.72);}

    .toolbar{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #f4f7ff;
      padding: 9px 12px;
      border-radius: 12px;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-size: 13px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn[aria-pressed="true"]{
      background: rgba(43,124,255,.18);
      border-color: rgba(43,124,255,.35);
    }

    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      font-size: 12px;
    }
    input[type="range"]{ width: 160px; }

    /* --- Book layout --- */
    .spread{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      align-items: stretch;
    }
    .spread.two{ grid-template-columns: 1fr 1fr; }

    .page{
      background: var(--paper);
      color: var(--ink);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(18,22,28,.08);
      overflow: hidden;
      position: relative;
      min-height: 560px;
    }
    .page::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(0,0,0,.06), transparent 20%, transparent 80%, rgba(0,0,0,.06));
      opacity:.22;
      pointer-events:none;
    }
    .page[data-side="left"]::after{
      content:"";
      position:absolute; top:0; bottom:0; right:0;
      width: 26px;
      background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.12));
      opacity:.55;
      pointer-events:none;
    }
    .page[data-side="right"]::after{
      content:"";
      position:absolute; top:0; bottom:0; left:0;
      width: 26px;
      background: linear-gradient(90deg, rgba(0,0,0,.12), rgba(0,0,0,0));
      opacity:.55;
      pointer-events:none;
    }

    .page-inner{
      padding: 32px 34px 38px;
      position: relative;
      z-index: 1;
      font-family: var(--serif);
      font-size: 18px;
      line-height: 1.65;
    }
    .page h1{ margin:0 0 10px; font-size: 26px; }
    .meta{
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .page p{ margin: 0 0 14px; }

    .note{
      font-family: var(--sans);
      font-size: 13px;
      line-height: 1.45;
      color: #1a2430;
      border-left: 3px solid rgba(43,124,255,.55);
      background: rgba(43,124,255,.08);
      padding: 10px 12px;
      border-radius: 12px;
      margin: 12px 0 16px;
    }

    /* ‚ÄúIncastro‚Äù: immagine flottante nel flusso */
    figure.float-media{
      float: right;
      width: min(44%, 360px);
      margin: 6px 0 12px 14px;
      border: 1px solid rgba(18,22,28,.10);
      border-radius: 14px;
      overflow: hidden;
      background: #f8fafc;
    }
    figure.float-media figcaption{
      font-family: var(--sans);
      font-size: 12px;
      color: #394455;
      padding: 8px 10px;
      border-top: 1px solid rgba(18,22,28,.08);
      background: #fff;
    }
    .thumb{
      display:block;
      width:100%;
      height:auto;
      cursor: zoom-in;
    }

    /* Video box responsive */
    .video-box{
      margin: 14px 0 6px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(18,22,28,.10);
      background:#0b1220;
    }
    .video-box iframe{
      width:100%;
      aspect-ratio: 16/9;
      border:0;
      display:block;
    }

    /* Modal zoom/pan */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(10,12,16,.68);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 18px;
    }
    .modal.open{ display:flex; }

    .modal-card{
      width: min(1100px, 100%);
      height: min(760px, 92vh);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      display:grid;
      grid-template-rows: auto 1fr;
    }
    .modal-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.25);
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .modal-top .title{
      font-size: 13px;
      color: rgba(255,255,255,.92);
      font-family: var(--sans);
    }
    .modal-actions{ display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
    .iconbtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-size: 12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .iconbtn:hover{ background: rgba(255,255,255,.12); }

    .stage{
      position: relative;
      overflow: hidden;
      background: rgba(255,255,255,.06);
      touch-action: none;
    }
    .zoomable{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%) scale(1);
      transform-origin: center;
      cursor: grab;
      max-width: none;
      width: 1200px;
      height: auto;
      user-select: none;
      -webkit-user-drag: none;
      border-radius: 14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      touch-action: none;
    }
    .zoomable:active{ cursor: grabbing; }

    .pager-hint{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-family: var(--sans);
      font-size: 12px;
      color: rgba(232,237,245,.75);
    }

    /* =========================
       Finestra Appunti flottante
       ========================= */
    .notes-window{
      position: fixed;
      right: 22px;
      bottom: 22px;
      width: min(520px, calc(100vw - 44px));
      height: 320px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 80;
      display: none;
      overflow: hidden;
    }
    .notes-window.open{ display: grid; grid-template-rows: auto 1fr auto; }

    .notes-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.25);
      border-bottom: 1px solid rgba(255,255,255,.12);
      cursor: grab;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .notes-top:active{ cursor: grabbing; }

    .notes-title{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .notes-title strong{
      font-size: 13px;
      color: rgba(255,255,255,.92);
      font-family: var(--sans);
      letter-spacing:.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .notes-title span{
      font-size: 11px;
      color: rgba(255,255,255,.70);
      font-family: var(--sans);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .notes-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      flex-shrink:0;
    }

    .notes-body{
      padding: 10px 12px;
      background: rgba(255,255,255,.06);
    }
    .notes-text{
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      resize: none;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.92);
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.45;
      padding: 10px 12px;
      outline: none;
    }
    .notes-text::placeholder{ color: rgba(255,255,255,.55); }

    .notes-bottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-family: var(--sans);
      font-size: 12px;
      color: rgba(255,255,255,.75);
    }
    .status-dot{
      display:inline-block;
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: rgba(255,255,255,.45);
      vertical-align: middle;
      margin-right: 8px;
    }
    .status-dot.ok{ background: rgba(57,217,138,.9); }
    .status-dot.warn{ background: rgba(255,220,60,.9); }
    .status-dot.err{ background: rgba(255,77,77,.9); }

    /* Indice */
    .toc{
      font-family: var(--sans);
      background: rgba(43,124,255,.06);
      border: 1px solid rgba(43,124,255,.20);
      border-radius: 16px;
      padding: 14px 14px 10px;
      margin: 0 0 16px;
    }
    .toc-title{
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .toc ul{ margin: 0; padding-left: 18px; }
    .toc li{ margin: 6px 0; }
    .toc a{ color: #1b4aa8; text-decoration: none; }
    .toc a:hover{ text-decoration: underline; }
    .soon{
      font-size: 11px;
      color: rgba(18,22,28,.55);
      margin-left: 6px;
    }

    /* Galleria immagini (pagina destra) */
    .gallery{ display:flex; flex-direction:column; gap: 14px; }
    figure.media{
      margin: 0;
      border: 1px solid rgba(18,22,28,.10);
      border-radius: 14px;
      overflow:hidden;
      background: #f8fafc;
    }
    figure.media figcaption{
      font-family: var(--sans);
      font-size: 12px;
      color: #394455;
      padding: 8px 10px;
      border-top: 1px solid rgba(18,22,28,.08);
      background: #fff;
    }


    @media (max-width: 980px){
      .spread.two{ grid-template-columns: 1fr; }
      figure.float-media{ float:none; width: 100%; margin: 8px 0 14px; }
      input[type="range"]{ width: 140px; }
      .notes-window{ right: 14px; bottom: 14px; width: calc(100vw - 28px); }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <strong>Pirandello ‚Äî Web app</strong>
        <span>Lezione + immagini ¬∑ zoom/pan ¬∑ appunti</span>
      </div>

      <div class="toolbar">
        <button class="btn" id="toggleTwo" aria-pressed="false">‚ÜîÔ∏é Vista 2 pagine</button>

        <div class="pill" title="Dimensione del testo">
          A‚àí <input id="font" type="range" min="15" max="24" value="18" /> A+
        </div>

        <button class="btn" id="prev">‚óÄÔ∏é Pagina 1</button>
        <button class="btn" id="next">Pagina 2 ‚ñ∂Ô∏é</button>

        <button class="btn" id="toggleNotes" aria-pressed="false" title="Apri/chiudi appunti">
          üìù Appunti
        </button>
      </div>
    </header>

    <main>
      <div class="spread" id="spread">
        <!-- PAGINA 1 -->
        <article class="page" data-side="left" id="page1" aria-label="Pagina 1">
          <div class="page-inner">
            <h1>Pirandello ‚Äî La visione del mondo</h1>
            <div class="meta">
              <span>Sezione attiva: visione del mondo</span>
              <span>Testo: selezionabile</span>
              <span>Appunti: autosave + export</span>
            </div>

            
<nav class="toc" aria-label="Indice della lezione">
  <h2 class="toc-title">Indice</h2>
  <ul>
    <li><a href="#umorismo">La poetica dell‚Äôumorismo</a> <span class="soon">in arrivo</span></li>
    <li><a href="#romanzi">I romanzi</a> <span class="soon">in arrivo</span>
      <ul>
        <li><a href="#mattia">Il fu Mattia Pascal</a> <span class="soon">in arrivo</span></li>
        <li><a href="#uno">Uno, nessuno e centomila</a> <span class="soon">in arrivo</span></li>
      </ul>
    </li>
    <li><a href="#teatro">Il teatro</a> <span class="soon">in arrivo</span>
      <ul>
        <li><a href="#cosi">Cos√¨ √® (se vi pare)</a> <span class="soon">in arrivo</span></li>
        <li><a href="#sei">Sei personaggi in cerca d‚Äôautore</a> <span class="soon">in arrivo</span></li>
      </ul>
    </li>
    <li><a href="#sintesi">Sintesi generale</a> <span class="soon">in arrivo</span></li>
    <li><a href="#visione">La visione del mondo</a></li>
    <li><a href="#vocabolario">Vocabolario essenziale</a></li>
    <li><a href="#saperi">Saperi irrinunciabili</a></li>
  </ul>
</nav>


            
<section id="umorismo"><h2>La poetica dell‚Äôumorismo</h2><p><em>Sezione in costruzione.</em></p></section>
<section id="romanzi"><h2>I romanzi</h2><p><em>Sezione in costruzione.</em></p></section>
<section id="mattia"><h3>Il fu Mattia Pascal</h3><p><em>Sezione in costruzione.</em></p></section>
<section id="uno"><h3>Uno, nessuno e centomila</h3><p><em>Sezione in costruzione.</em></p></section>
<section id="teatro"><h2>Il teatro</h2><p><em>Sezione in costruzione.</em></p></section>
<section id="cosi"><h3>Cos√¨ √® (se vi pare)</h3><p><em>Sezione in costruzione.</em></p></section>
<section id="sei"><h3>Sei personaggi in cerca d‚Äôautore</h3><p><em>Sezione in costruzione.</em></p></section>
<section id="sintesi"><h2>Sintesi generale</h2><p><em>Sezione in costruzione.</em></p></section>


            <section id="visione">
<h2>La visione del mondo</h2>
<p>Le opere di Pirandello si fondano su un presupposto filosofico: il vitalismo di Bergson. Secondo questa concezione, la vita √® un divenire incessante, un flusso continuo di trasformazioni. Ogni essere passa da uno stato all‚Äôaltro e chi tenta di sottrarsi a questo movimento perenne, fissandosi in una forma immobile, si condanna alla morte interiore.</p>
<p>Da tale visione nasce uno dei temi centrali della sua opera: l‚Äôincomunicabilit√†. L‚Äôuomo europeo del primo Novecento vive in una societ√† complessa, artificiale e spesso estranea. Ha perduto le certezze legate al mondo contadino, fatto di ritmi naturali e di cose semplici che davano senso all‚Äôesistenza, sostituendole con un tempo e uno spazio innaturali, propri della modernit√†.</p>
<p>Pirandello estende la sua critica alle strutture portanti della civilt√† occidentale. La famiglia, che in Pascoli era simbolo di rifugio e protezione, diventa in Pirandello luogo di incomunicabilit√†, tensioni e rancori: da nido rassicurante a carcere opprimente. Anche il lavoro, che dovrebbe essere occasione di crescita e realizzazione, si riduce a meccanismo alienante che priva l‚Äôuomo della propria identit√†. Cos√¨, famiglia e lavoro, fondamenta della societ√† borghese, si rivelano maschere collettive che nascondono il vuoto.</p>
<p>L‚Äôindividuo, in questo contesto, si scopre frammentato: per gli altri √® centomila personalit√†, mentre per s√© stesso non √® che nessuno. Ne deriva lo stupore doloroso dei personaggi pirandelliani, che cercano invano una via di fuga per affermare s√© stessi. Ogni volta che tentano di uscire dal flusso vitale per darsi una forma definita, non fanno che indossare una nuova maschera. √à questo il destino comune agli eroi di Pirandello: fuggire dal grigiore quotidiano per scoprire, infine, di essere esclusi dalla societ√†, condannati a restare ‚Äúnessuno‚Äù.</p>
</section>
<section id="vocabolario">
<h2>Vocabolario essenziale</h2>
<ul>
<li><strong>Vitalismo di Bergson</strong>: concezione filosofica secondo cui la vita √® un flusso incessante di trasformazioni; ogni tentativo di fissarla in forme statiche conduce alla morte interiore.</li>
<li><strong>Flusso perenne</strong>: la vita come movimento continuo, divenire senza sosta, in cui nulla resta identico a s√© stesso.</li>
<li><strong>Incomunicabilit√†</strong>: impossibilit√† di comprendersi pienamente tra individui, poich√© ognuno vive una realt√† soggettiva, frammentata e irriducibile a quella altrui.</li>
<li><strong>Maschere sociali</strong>: ruoli imposti dalla societ√† (famiglia, lavoro, convenzioni) che soffocano l‚Äôautenticit√† dell‚Äôindividuo.</li>
<li><strong>Famiglia</strong>: non pi√π nido di protezione, ma luogo di tensioni, rancori e incomunicabilit√†.</li>
<li><strong>Lavoro</strong>: ridotto a meccanismo alienante che priva l‚Äôuomo della propria identit√† e lo riduce a ingranaggio impersonale.</li>
<li><strong>Uno, nessuno e centomila</strong>: formula che sintetizza la condizione dell‚Äôuomo moderno: uno per s√©, centomila per gli altri, e in fondo nessuno.</li>
<li><strong>Il nuovo eroe</strong>: il ‚Äúnessuno‚Äù: figura centrale nella visione pirandelliana; rappresenta l‚Äôindividuo che, perso nel gioco delle maschere, non pu√≤ pi√π definirsi con un‚Äôidentit√† stabile.</li>
</ul></section>
<section id="saperi">
<h2>Saperi irrinunciabili</h2><ol>
<li>La filosofia di riferimento per Pirandello √® il vitalismo di Bergson, che concepisce la vita come flusso continuo di cambiamento.</li>
<li>L‚Äôuomo che tenta di sottrarsi a questo divenire fissandosi in un ruolo stabile si condanna a una forma di morte interiore.</li>
<li>Il Novecento europeo appare a Pirandello come un‚Äôepoca segnata dall‚Äôincomunicabilit√†, effetto della perdita delle certezze legate al mondo contadino e dell‚Äôaffermarsi della modernit√† artificiale.</li>
<li>Famiglia e lavoro, pilastri della societ√† borghese, si rivelano maschere collettive che imprigionano l‚Äôindividuo invece di proteggerlo e valorizzarlo.</li>
<li>L‚Äôindividuo vive una condizione frammentata: agli occhi degli altri √® centomila personalit√† diverse, ma dentro di s√© si percepisce nessuno.</li>
<li>Ogni tentativo di definizione stabile porta solo a una nuova maschera, non a una vera identit√† autentica.</li>
<li>Il destino dell‚Äôeroe pirandelliano √® la scoperta dolorosa della propria nullit√† sociale: escluso dal consesso umano, resta un ‚Äúnessuno‚Äù.</li>
</ol></section>
</div>
        </article>

        <!-- PAGINA 2 -->
        <article class="page" data-side="right" id="page2" aria-label="Pagina 2">
          <div class="page-inner">
            <h1>Immagini</h1>
            <div class="meta">
              <span>Ordine: Pirandello ‚Üí schemi</span>
              <span>Zoom: clic ¬∑ rotella ¬∑ trascina</span>
              <span>Reset: pulsante</span>
            </div>

            <div class="gallery">
  <figure class="media">
      <img class="thumb" src="assets/pirandello-ritratto.png" alt="Luigi Pirandello (immagine di apertura) (clicca per zoom)" />
      <figcaption><strong>Luigi Pirandello (immagine di apertura)</strong> ‚Äî Luigi Pirandello (immagine di apertura)</figcaption>
    </figure>
  <figure class="media">
      <img class="thumb" src="assets/visione-del-mondo.png" alt="Schema ‚Äî La visione del mondo (clicca per zoom)" />
      <figcaption><strong>Schema</strong> ‚Äî Schema ‚Äî La visione del mondo</figcaption>
    </figure>
  <figure class="media">
      <img class="thumb" src="assets/concezione-filosofica.png" alt="Schema ‚Äî Concezione filosofica (clicca per zoom)" />
      <figcaption><strong>Schema</strong> ‚Äî Schema ‚Äî Concezione filosofica</figcaption>
    </figure>
  <figure class="media">
      <img class="thumb" src="assets/realta-multiforme.png" alt="Schema ‚Äî La realt√† √® multiforme (clicca per zoom)" />
      <figcaption><strong>Schema</strong> ‚Äî Schema ‚Äî La realt√† √® multiforme</figcaption>
    </figure>
  <figure class="media">
      <img class="thumb" src="assets/il-nessuno.png" alt="Schema ‚Äî Il ‚Äúnessuno‚Äù (clicca per zoom)" />
      <figcaption><strong>Schema</strong> ‚Äî Schema ‚Äî Il ‚Äúnessuno‚Äù</figcaption>
    </figure>
  <figure class="media">
      <img class="thumb" src="assets/societa-borghese.png" alt="Schema ‚Äî Pirandello e la societ√† borghese (clicca per zoom)" />
      <figcaption><strong>Schema</strong> ‚Äî Schema ‚Äî Pirandello e la societ√† borghese</figcaption>
    </figure>
</div>

            <div class="note">
              Suggerimento: su LIM/iPad, apri l‚Äôimmagine in zoom e muoviti con pan + rotella. Gli schemi restano leggibili.
            </div>
</div>
        </article>
      </div>

      <div class="pager-hint">
        <span>Zoom: rotella ¬∑ Pan: trascina ¬∑ Reset: pulsante ¬∑ Chiudi zoom: Esc</span>
        <span>Appunti: trascina la barra in alto ¬∑ Autosave + Export .txt</span>
      </div>
    </main>
  </div>

  <!-- MODAL ZOOM/PAN -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Zoom immagine">
    <div class="modal-card">
      <div class="modal-top">
        <div class="title">Zoom/Pan ‚Äî immagine navigabile</div>
        <div class="modal-actions">
          <button class="iconbtn" id="zoomOut">‚àí</button>
          <button class="iconbtn" id="zoomIn">+</button>
          <button class="iconbtn" id="resetZoom">Reset</button>
          <button class="iconbtn" id="closeZoom">Chiudi</button>
        </div>
      </div>
      <div class="stage" id="stage">
        <img id="zoomImg" class="zoomable" alt="Immagine zoomabile" />
      </div>
    </div>
  </div>

  <!-- FINESTRA APPUNTI -->
  <section class="notes-window" id="notesWin" aria-label="Finestra appunti">
    <div class="notes-top" id="notesDrag">
      <div class="notes-title">
        <strong>Appunti</strong>
        <span id="notesSub">Salvataggio automatico per questa lezione</span>
      </div>
      <div class="notes-actions">
        <button class="iconbtn" id="exportTxt" title="Esporta appunti in .txt">Export .txt</button>
        <button class="iconbtn" id="clearNotes" title="Svuota appunti">Svuota</button>
        <button class="iconbtn" id="closeNotes" title="Chiudi">Chiudi</button>
      </div>
    </div>

    <div class="notes-body">
      <textarea class="notes-text" id="notesText"
        placeholder="Scrivi qui i tuoi appunti‚Ä¶ (si salvano da soli)"></textarea>
    </div>

    <div class="notes-bottom">
      <div><span class="status-dot" id="dot"></span><span id="status">Pronto</span></div>
      <div id="counter">0 caratteri</div>
    </div>
  </section>

  <script>
    /* =========================
       Vista 1/2 pagine + font
       ========================= */
    const spread = document.getElementById('spread');
    const toggleTwo = document.getElementById('toggleTwo');
    let twoPages = true;
    spread.classList.add('two');
    toggleTwo.setAttribute('aria-pressed','true');
    toggleTwo.textContent = '‚ÜîÔ∏é Vista 1 pagina';
    toggleTwo.addEventListener('click', () => {
      twoPages = !twoPages;
      spread.classList.toggle('two', twoPages);
      toggleTwo.setAttribute('aria-pressed', String(twoPages));
      toggleTwo.textContent = twoPages ? '‚ÜîÔ∏é Vista 1 pagina' : '‚ÜîÔ∏é Vista 2 pagine';
    });

    const font = document.getElementById('font');
    font.addEventListener('input', () => {
      const px = Number(font.value);
      document.querySelectorAll('.page-inner').forEach(el => el.style.fontSize = px + 'px');
    });

    const page1 = document.getElementById('page1');
    const page2 = document.getElementById('page2');
    document.getElementById('prev').textContent = '‚óÄÔ∏é Testo';
    document.getElementById('next').textContent = 'Immagini ‚ñ∂Ô∏é';
    document.getElementById('prev').addEventListener('click', () => page1.scrollIntoView({behavior:'smooth', block:'start'}));
    document.getElementById('next').addEventListener('click', () => page2.scrollIntoView({behavior:'smooth', block:'start'}));

    /* =========================
       Zoom/Pan immagine
       ========================= */
    const modal = document.getElementById('modal');
    const thumbs = Array.from(document.querySelectorAll('.thumb'));
    const zoomImg = document.getElementById('zoomImg');
    const stage = document.getElementById('stage');
    const closeZoom = document.getElementById('closeZoom');
    const resetZoom = document.getElementById('resetZoom');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');

    let scale = 1, tx = 0, ty = 0;
    let dragging = false, startX = 0, startY = 0;

    function applyTransform(){
      zoomImg.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`;
    }
    function openZoom(src){
      zoomImg.src = src;
      scale = 1; tx = 0; ty = 0;
      applyTransform();
      modal.classList.add('open');
      closeZoom.focus();
    }
    function closeZoomModal(){
      modal.classList.remove('open');
      dragging = false;
    }

    thumbs.forEach(t => t.addEventListener('click', () => openZoom(t.src)));
    closeZoom.addEventListener('click', closeZoomModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeZoomModal(); });

    resetZoom.addEventListener('click', () => { scale = 1; tx = 0; ty = 0; applyTransform(); });
    zoomIn.addEventListener('click', () => { scale = Math.min(6, +(scale + 0.2).toFixed(2)); applyTransform(); });
    zoomOut.addEventListener('click', () => { scale = Math.max(0.6, +(scale - 0.2).toFixed(2)); applyTransform(); });

    stage.addEventListener('wheel', (e) => {
      if(!modal.classList.contains('open')) return;
      e.preventDefault();
      const d = Math.sign(e.deltaY);
      scale = d > 0 ? Math.max(0.6, +(scale - 0.12).toFixed(2)) : Math.min(6, +(scale + 0.12).toFixed(2));
      applyTransform();
    }, {passive:false});

    zoomImg.addEventListener('pointerdown', (e) => {
      dragging = true;
      startX = e.clientX - tx;
      startY = e.clientY - ty;
      zoomImg.setPointerCapture(e.pointerId);
    });
    zoomImg.addEventListener('pointermove', (e) => {
      if(!dragging) return;
      tx = e.clientX - startX;
      ty = e.clientY - startY;
      applyTransform();
    });
    zoomImg.addEventListener('pointerup', () => dragging = false);
    zoomImg.addEventListener('pointercancel', () => dragging = false);

    /* =========================
       Finestra Appunti: toggle + drag + autosave + export
       ========================= */
    const toggleNotes = document.getElementById('toggleNotes');
    const notesWin = document.getElementById('notesWin');
    const notesDrag = document.getElementById('notesDrag');
    const notesText = document.getElementById('notesText');
    const closeNotes = document.getElementById('closeNotes');
    const exportTxt = document.getElementById('exportTxt');
    const clearNotes = document.getElementById('clearNotes');
    const statusEl = document.getElementById('status');
    const dot = document.getElementById('dot');
    const counter = document.getElementById('counter');
    const notesSub = document.getElementById('notesSub');

    // Chiave per-file (ogni lezione html ha i suoi appunti)
    const NOTES_KEY = `mw_notes::${location.pathname}`;
    const POS_KEY   = `mw_notes_pos::${location.pathname}`;

    function setStatus(kind, text){
      statusEl.textContent = text;
      dot.classList.remove('ok','warn','err');
      if(kind) dot.classList.add(kind);
    }

    function getTopZ(){
      const z = Number(notesWin.dataset.z || '80') + 1;
      notesWin.dataset.z = String(z);
      return z;
    }

    function openNotes(){
      notesWin.classList.add('open');
      toggleNotes.setAttribute('aria-pressed', 'true');
      notesWin.style.zIndex = String(getTopZ());
      notesText.focus();
    }
    function closeNotesWin(){
      notesWin.classList.remove('open');
      toggleNotes.setAttribute('aria-pressed', 'false');
    }

    toggleNotes.addEventListener('click', () => {
      const open = notesWin.classList.contains('open');
      open ? closeNotesWin() : openNotes();
    });
    closeNotes.addEventListener('click', closeNotesWin);

    // Ripristino testo salvato
    const saved = localStorage.getItem(NOTES_KEY);
    if(saved !== null) {
      notesText.value = saved;
      setStatus('ok','Recuperati');
    } else {
      setStatus(null,'Pronto');
    }

    // Ripristino posizione finestra (se salvata)
    const savedPos = localStorage.getItem(POS_KEY);
    if(savedPos){
      try{
        const p = JSON.parse(savedPos);
        if(typeof p.left === 'number') notesWin.style.left = p.left + 'px';
        if(typeof p.top === 'number')  notesWin.style.top  = p.top  + 'px';
        notesWin.style.right = 'auto';
        notesWin.style.bottom = 'auto';
      }catch{}
    }

    notesSub.textContent = `Lezione: ${location.pathname.split('/').pop() || 'index.html'}`;

    // Autosave (debounce)
    let saveTimer = null;
    function scheduleSave(){
      setStatus('warn','Scrivendo‚Ä¶');
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        try{
          localStorage.setItem(NOTES_KEY, notesText.value);
          setStatus('ok','Salvati');
        }catch(e){
          setStatus('err','Errore salvataggio');
        }
      }, 350);
    }

    function updateCounter(){
      counter.textContent = `${notesText.value.length} caratteri`;
    }
    updateCounter();

    notesText.addEventListener('input', () => {
      updateCounter();
      scheduleSave();
    });

    // Export .txt
    exportTxt.addEventListener('click', () => {
      const blob = new Blob([notesText.value], {type: 'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      const lessonName = (location.pathname.split('/').pop() || 'lezione').replace('.html','');
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href = URL.createObjectURL(blob);
      a.download = `${lessonName}-appunti-${stamp}.txt`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    });

    // Svuota appunti
    clearNotes.addEventListener('click', () => {
      notesText.value = '';
      updateCounter();
      localStorage.setItem(NOTES_KEY, '');
      setStatus('ok','Svuotati');
      notesText.focus();
    });

    // Drag finestra (mouse/touch) sulla barra in alto
    let drag = {active:false, startX:0, startY:0, startLeft:0, startTop:0};
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    notesDrag.addEventListener('pointerdown', (e) => {
      drag.active = true;
      notesWin.style.zIndex = String(getTopZ());
      notesDrag.setPointerCapture(e.pointerId);

      const rect = notesWin.getBoundingClientRect();
      drag.startX = e.clientX;
      drag.startY = e.clientY;
      drag.startLeft = rect.left;
      drag.startTop = rect.top;

      notesWin.style.left = rect.left + 'px';
      notesWin.style.top = rect.top + 'px';
      notesWin.style.right = 'auto';
      notesWin.style.bottom = 'auto';
    });

    notesDrag.addEventListener('pointermove', (e) => {
      if(!drag.active) return;
      const dx = e.clientX - drag.startX;
      const dy = e.clientY - drag.startY;

      const rect = notesWin.getBoundingClientRect();
      const w = rect.width, h = rect.height;

      const maxLeft = window.innerWidth - w - 8;
      const maxTop  = window.innerHeight - h - 8;

      const left = clamp(drag.startLeft + dx, 8, maxLeft);
      const top  = clamp(drag.startTop + dy, 8, maxTop);

      notesWin.style.left = left + 'px';
      notesWin.style.top = top + 'px';
    });

    notesDrag.addEventListener('pointerup', () => {
      if(!drag.active) return;
      drag.active = false;
      const rect = notesWin.getBoundingClientRect();
      localStorage.setItem(POS_KEY, JSON.stringify({left: rect.left, top: rect.top}));
    });
    notesDrag.addEventListener('pointercancel', () => drag.active = false);

    // Esc chiude zoom; Ctrl/Cmd+K apre appunti
    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && modal.classList.contains('open')) closeZoomModal();
      const isMac = navigator.platform.toLowerCase().includes('mac');
      const cmd = isMac ? e.metaKey : e.ctrlKey;
      if(cmd && (e.key.toLowerCase() === 'k')){
        e.preventDefault();
        const open = notesWin.classList.contains('open');
        open ? closeNotesWin() : openNotes();
      }
    });
  </script>
</body>
</html>
