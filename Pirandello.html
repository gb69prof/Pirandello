<script>
  // ====== INDICE (solo per link interni #...; i link a pagine esterne non vengono toccati) ======
  document.querySelectorAll('.index a').forEach(a=>{
    a.addEventListener('click',(e)=>{
      const href=a.getAttribute('href');
      if(!href || !href.startsWith('#')) return;
      const target=document.querySelector(href);
      if(!target) return;
      e.preventDefault();
      target.scrollIntoView({behavior:'smooth', block:'start'});
    });
  });

  // ====== 2 PAGINE ======
  const pages = document.getElementById('pages');
  const toggleTwo = document.getElementById('toggleTwo');
  let twoPages = false;

  if (toggleTwo && pages) {
    toggleTwo.addEventListener('click',()=>{
      twoPages = !twoPages;
      pages.classList.toggle('two', twoPages);
      toggleTwo.setAttribute('aria-pressed', String(twoPages));
      toggleTwo.textContent = twoPages ? '↔︎ 1 pagina' : '↔︎ 2 pagine';
    });
  }

  // ====== FONT SIZE ======
  const font = document.getElementById('font');
  if (font) {
    font.addEventListener('input',()=>{
      const px = Number(font.value);
      document.querySelectorAll('.page-inner').forEach(el=>el.style.fontSize = px + 'px');
    });
  }

  // ====== POPUP IMMAGINI (zoom + pan + reset + drag finestra + resize finestra) ======
  const imgPop   = document.getElementById('imgPop');
  const popDrag  = document.getElementById('popDrag');
  const popResize= document.getElementById('popResize');
  const popTitle = document.getElementById('popTitle');
  const popImg   = document.getElementById('popImg');
  const popStage = document.getElementById('popStage');
  const popClose = document.getElementById('popClose');
  const popReset = document.getElementById('popReset');
  const popZoomIn= document.getElementById('popZoomIn');
  const popZoomOut=document.getElementById('popZoomOut');

  let pscale=1, ptx=0, pty=0;
  let pdrag={active:false, startX:0, startY:0, startLeft:0, startTop:0};
  let presize={active:false, startX:0, startY:0, startW:0, startH:0};
  let imgPan={active:false, startX:0, startY:0, startTx:0, startTy:0};

  const clamp=(n,min,max)=>Math.max(min, Math.min(max,n));
  const applyPopTransform=()=> {
    if (!popImg) return;
    popImg.style.transform = `translate(calc(-50% + ${ptx}px), calc(-50% + ${pty}px)) scale(${pscale})`;
  };

  function openImagePop(src,title){
    if(!imgPop || !popImg || !popTitle) return;
    popImg.src = src;
    popTitle.textContent = title || 'Immagine';
    pscale=1; ptx=0; pty=0; applyPopTransform();

    imgPop.style.width='min(920px, 92vw)';
    imgPop.style.height='min(640px, 80vh)';
    imgPop.style.left='50%';
    imgPop.style.top='50%';
    imgPop.style.transform='translate(-50%,-50%)';
    imgPop.classList.add('open');
    if (popClose) popClose.focus();
  }

  function closeImagePop(){
    if(!imgPop) return;
    imgPop.classList.remove('open');
    imgPan.active=false; pdrag.active=false; presize.active=false;
  }

  document.querySelectorAll('img.thumb').forEach(img=>{
    img.addEventListener('click', ()=>openImagePop(img.src, img.dataset.title || img.alt || 'Immagine'));
  });

  if (popClose) popClose.addEventListener('click', closeImagePop);
  if (popReset) popReset.addEventListener('click', ()=>{pscale=1; ptx=0; pty=0; applyPopTransform();});
  if (popZoomIn) popZoomIn.addEventListener('click', ()=>{pscale=Math.min(6, +(pscale+0.2).toFixed(2)); applyPopTransform();});
  if (popZoomOut) popZoomOut.addEventListener('click', ()=>{pscale=Math.max(0.6, +(pscale-0.2).toFixed(2)); applyPopTransform();});

  if (popStage) {
    popStage.addEventListener('wheel',(e)=>{
      if(!imgPop || !imgPop.classList.contains('open')) return;
      e.preventDefault();
      const d=Math.sign(e.deltaY);
      pscale = d>0 ? Math.max(0.6, +(pscale-0.12).toFixed(2)) : Math.min(6, +(pscale+0.12).toFixed(2));
      applyPopTransform();
    }, {passive:false});
  }

  if (popImg) {
    popImg.addEventListener('pointerdown',(e)=>{
      imgPan.active=true;
      imgPan.startX=e.clientX; imgPan.startY=e.clientY;
      imgPan.startTx=ptx; imgPan.startTy=pty;
      popImg.setPointerCapture(e.pointerId);
    });
    popImg.addEventListener('pointermove',(e)=>{
      if(!imgPan.active) return;
      const dx=e.clientX-imgPan.startX, dy=e.clientY-imgPan.startY;
      ptx=imgPan.startTx+dx; pty=imgPan.startTy+dy;
      applyPopTransform();
    });
    popImg.addEventListener('pointerup',()=>imgPan.active=false);
    popImg.addEventListener('pointercancel',()=>imgPan.active=false);
  }

  if (popDrag && imgPop) {
    popDrag.addEventListener('pointerdown',(e)=>{
      pdrag.active=true;
      popDrag.setPointerCapture(e.pointerId);
      const r=imgPop.getBoundingClientRect();
      pdrag.startX=e.clientX; pdrag.startY=e.clientY;
      pdrag.startLeft=r.left; pdrag.startTop=r.top;
      imgPop.style.left=r.left+'px';
      imgPop.style.top=r.top+'px';
      imgPop.style.transform='none';
    });
    popDrag.addEventListener('pointermove',(e)=>{
      if(!pdrag.active) return;
      const dx=e.clientX-pdrag.startX, dy=e.clientY-pdrag.startY;
      const r=imgPop.getBoundingClientRect(), w=r.width, h=r.height;
      imgPop.style.left = clamp(pdrag.startLeft+dx, 8, window.innerWidth-w-8) + 'px';
      imgPop.style.top  = clamp(pdrag.startTop +dy, 8, window.innerHeight-h-8) + 'px';
    });
    popDrag.addEventListener('pointerup',()=>pdrag.active=false);
    popDrag.addEventListener('pointercancel',()=>pdrag.active=false);
  }

  if (popResize && imgPop) {
    popResize.addEventListener('pointerdown',(e)=>{
      presize.active=true;
      popResize.setPointerCapture(e.pointerId);
      const r=imgPop.getBoundingClientRect();
      presize.startX=e.clientX; presize.startY=e.clientY;
      presize.startW=r.width; presize.startH=r.height;
    });
    popResize.addEventListener('pointermove',(e)=>{
      if(!presize.active) return;
      const dx=e.clientX-presize.startX, dy=e.clientY-presize.startY;
      imgPop.style.width  = clamp(presize.startW+dx, 320, window.innerWidth-16) + 'px';
      imgPop.style.height = clamp(presize.startH+dy, 240, window.innerHeight-16) + 'px';
    });
    popResize.addEventListener('pointerup',()=>presize.active=false);
    popResize.addEventListener('pointercancel',()=>presize.active=false);
  }

  // ====== VIDEO FOTO ↔ VIDEO (FIX ROBUSTO) ======
  const authorImg   = document.getElementById('authorImg');
  const heygenWrap  = document.getElementById('heygenWrap');
  const heygenIframe= document.getElementById('heygenIframe');
  const backToImg   = document.getElementById('backToImg');
  const mediaState  = document.getElementById('mediaState');

  const HEYGEN_SRC = "https://app.heygen.com/embedded-player/70ac565e14cd4e8b83052dc76434961e";

  if (heygenIframe) {
    // aiuta compatibilità Safari/Autoplay
    heygenIframe.setAttribute("allow", "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture");
    heygenIframe.setAttribute("allowfullscreen", "");
  }

  function showVideo(){
    if (!heygenWrap || !authorImg || !mediaState || !heygenIframe) return;

    // ✅ Safari: iframe.src non torna mai davvero “vuoto”, quindi usiamo setAttribute sempre
    heygenIframe.setAttribute("src", HEYGEN_SRC);

    heygenWrap.style.display = "block";
    heygenWrap.setAttribute("aria-hidden","false");

    authorImg.style.visibility = "hidden";
    mediaState.textContent = "video";
  }

  function showImage(){
    if (!heygenWrap || !authorImg || !mediaState || !heygenIframe) return;

    // ✅ scarico reale del player
    heygenIframe.setAttribute("src", "about:blank");

    heygenWrap.style.display = "none";
    heygenWrap.setAttribute("aria-hidden","true");

    authorImg.style.visibility = "visible";
    mediaState.textContent = "foto";
  }

  if (authorImg) authorImg.addEventListener('click', showVideo);
  if (backToImg) backToImg.addEventListener('click', showImage);

  // tentativo di “ritorno automatico” se arriva un messaggio di fine riproduzione
  window.addEventListener("message", (event) => {
    try{
      const data = event.data;
      const str = typeof data === "string" ? data.toLowerCase() : "";
      const obj = (typeof data === "object" && data) ? JSON.stringify(data).toLowerCase() : "";
      if(str.includes("ended") || str.includes("complete") || obj.includes("ended") || obj.includes("complete")){
        showImage();
      }
    }catch(e){}
  });

  // ====== APPUNTI (autosave + posizione + export) ======
  const toggleNotes = document.getElementById('toggleNotes');
  const notesWin    = document.getElementById('notesWin');
  const notesDrag   = document.getElementById('notesDrag');
  const notesText   = document.getElementById('notesText');
  const closeNotes  = document.getElementById('closeNotes');
  const exportTxt   = document.getElementById('exportTxt');
  const clearNotes  = document.getElementById('clearNotes');
  const statusEl    = document.getElementById('status');
  const counter     = document.getElementById('counter');

  const NOTES_KEY = `mw_notes::${location.pathname}`;
  const POS_KEY   = `mw_notes_pos::${location.pathname}`;

  function openNotes(){
    if(!notesWin || !toggleNotes || !notesText) return;
    notesWin.classList.add('open');
    toggleNotes.setAttribute('aria-pressed','true');
    notesText.focus();
  }
  function closeNotesWin(){
    if(!notesWin || !toggleNotes) return;
    notesWin.classList.remove('open');
    toggleNotes.setAttribute('aria-pressed','false');
  }

  if (toggleNotes && notesWin) {
    toggleNotes.addEventListener('click', ()=> notesWin.classList.contains('open') ? closeNotesWin() : openNotes());
  }
  if (closeNotes) closeNotes.addEventListener('click', closeNotesWin);

  if (notesText) {
    const saved = localStorage.getItem(NOTES_KEY);
    if(saved!==null) notesText.value = saved;
  }

  function updateCounter(){
    if(!counter || !notesText) return;
    counter.textContent = `${notesText.value.length} caratteri`;
  }
  updateCounter();

  let saveTimer=null;
  if (notesText) {
    notesText.addEventListener('input', ()=>{
      updateCounter();
      if(statusEl) statusEl.textContent='Scrivendo…';
      clearTimeout(saveTimer);
      saveTimer=setTimeout(()=>{
        localStorage.setItem(NOTES_KEY, notesText.value);
        if(statusEl) statusEl.textContent='Salvati';
      }, 350);
    });
  }

  if (exportTxt && notesText) {
    exportTxt.addEventListener('click', ()=>{
      const blob=new Blob([notesText.value], {type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');
      const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=URL.createObjectURL(blob);
      a.download=`Pirandello-appunti-${stamp}.txt`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    });
  }

  if (clearNotes && notesText) {
    clearNotes.addEventListener('click', ()=>{
      notesText.value='';
      updateCounter();
      localStorage.setItem(NOTES_KEY,'');
      if(statusEl) statusEl.textContent='Svuotati';
      notesText.focus();
    });
  }

  // ripristino posizione appunti
  if (notesWin) {
    const savedPos=localStorage.getItem(POS_KEY);
    if(savedPos){
      try{
        const p=JSON.parse(savedPos);
        if(typeof p.left==='number') notesWin.style.left=p.left+'px';
        if(typeof p.top==='number')  notesWin.style.top =p.top +'px';
        notesWin.style.right='auto'; notesWin.style.bottom='auto';
      }catch{}
    }
  }

  // drag appunti
  let ndrag={active:false, startX:0, startY:0, startLeft:0, startTop:0};
  if (notesDrag && notesWin) {
    notesDrag.addEventListener('pointerdown',(e)=>{
      ndrag.active=true;
      notesDrag.setPointerCapture(e.pointerId);
      const r=notesWin.getBoundingClientRect();
      ndrag.startX=e.clientX; ndrag.startY=e.clientY;
      ndrag.startLeft=r.left; ndrag.startTop=r.top;
      notesWin.style.left=r.left+'px';
      notesWin.style.top=r.top+'px';
      notesWin.style.right='auto'; notesWin.style.bottom='auto';
    });
    notesDrag.addEventListener('pointermove',(e)=>{
      if(!ndrag.active) return;
      const dx=e.clientX-ndrag.startX, dy=e.clientY-ndrag.startY;
      const r=notesWin.getBoundingClientRect(), w=r.width, h=r.height;
      notesWin.style.left = clamp(ndrag.startLeft+dx, 8, window.innerWidth-w-8) + 'px';
      notesWin.style.top  = clamp(ndrag.startTop +dy, 8, window.innerHeight-h-8) + 'px';
    });
    notesDrag.addEventListener('pointerup', ()=>{
      if(!ndrag.active) return;
      ndrag.active=false;
      const r=notesWin.getBoundingClientRect();
      localStorage.setItem(POS_KEY, JSON.stringify({left:r.left, top:r.top}));
    });
    notesDrag.addEventListener('pointercancel', ()=>ndrag.active=false);
  }

  // ESC: chiude popup immagini e torna alla foto se video aperto
  window.addEventListener('keydown',(e)=>{
    if(e.key==='Escape'){
      if(imgPop && imgPop.classList.contains('open')) imgPop.classList.remove('open');
      if(mediaState && mediaState.textContent === "video") showImage();
    }
  });
</script>
