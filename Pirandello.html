<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pirandello ‚Äî Pagina (nuovo layout)</title>
  <style>
    :root{
      --bg:#0f141a;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(0,0,0,.14);
      --stroke:rgba(255,255,255,.16);
      --stroke2:rgba(255,255,255,.12);
      --text:#e8edf5;
      --muted:rgba(255,255,255,.70);
      --paper:#ffffff;
      --ink:#12161c;
      --shadow:0 14px 40px rgba(0,0,0,.28);
      --radius:18px;
      --serif:ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1100px 800px at 20% 10%, rgba(43,124,255,.18), transparent 60%),
        radial-gradient(1100px 800px at 85% 15%, rgba(139,92,246,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }

    /* HEADER */
    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 14px;
      backdrop-filter:blur(10px);
      background:rgba(15,20,26,.70);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .crumb{display:flex; align-items:center; gap:10px; flex-wrap:wrap; font-size:14px;}
    .crumb a{color:#f4f7ff; text-decoration:none; border-bottom:1px solid rgba(255,255,255,.18); padding-bottom:2px;}
    .crumb a:hover{border-bottom-color:rgba(255,255,255,.42);}
    .sep{color:rgba(232,237,245,.55);}
    .toolbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#f4f7ff;
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{background:rgba(255,255,255,.10);}
    .btn[aria-pressed="true"]{background:rgba(43,124,255,.18); border-color:rgba(43,124,255,.35);}
    .pill{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); font-size:12px;}
    input[type="range"]{width:150px;}

    /* LAYOUT */
    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:16px 14px 22px;
      box-sizing:border-box;
      display:grid;
      grid-template-columns:300px 1fr;
      gap:14px;
      align-items:start;
    }

    /* LEFT */
    .sidebar{
      position:sticky; top:66px;
      border-radius:var(--radius);
      background:var(--panel);
      border:1px solid var(--stroke);
      box-shadow:0 14px 40px rgba(0,0,0,.20);
      backdrop-filter:blur(10px);
      overflow:hidden;
    }
    .side-inner{padding:12px;}
    .author-card{
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    .author-img{width:100%; display:block; cursor:pointer;}
    .author-meta{padding:10px 10px 12px; color:rgba(255,255,255,.86); font-size:13px; line-height:1.35;}
    .author-meta strong{display:block; font-size:14px;}
    .author-meta span{color:rgba(255,255,255,.68); font-size:12px;}

    .side-title{margin:12px 2px 8px; font-size:13px; color:rgba(255,255,255,.78); text-transform:uppercase; letter-spacing:.8px;}
    .index{background:var(--panel2); border:1px solid var(--stroke2); border-radius:14px; overflow:hidden;}
    .index a{display:block; padding:10px 12px; color:rgba(255,255,255,.92); text-decoration:none; font-size:14px; border-top:1px solid rgba(255,255,255,.08);}
    .index a:first-child{border-top:0;}
    .index a:hover{background:rgba(255,255,255,.06);}
    .index small{color:rgba(255,255,255,.60); font-size:12px;}

    /* RIGHT PAGES */
    .pages{display:grid; grid-template-columns:1fr; gap:14px;}
    .pages.two{grid-template-columns:1fr 1fr;}

    .page{
      background:var(--paper);
      color:var(--ink);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(18,22,28,.08);
      overflow:hidden;
      position:relative;
      min-height:560px;
    }
    .page::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(0,0,0,.06), transparent 20%, transparent 80%, rgba(0,0,0,.06));
      opacity:.22; pointer-events:none;
    }
    .page-inner{
      padding:30px 32px 34px;
      position:relative; z-index:1;
      font-family:var(--serif);
      font-size:18px;
      line-height:1.65;
    }
    .page h1{margin:0 0 10px; font-size:28px;}
    .page h2{margin:18px 0 8px; font-size:20px;}
    .page h3{margin:16px 0 6px; font-size:18px;}
    .meta{font-family:var(--sans); font-size:12px; color:#5b6676; display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;}
    .note{
      font-family:var(--sans);
      font-size:13px;
      line-height:1.45;
      color:#1a2430;
      border-left:3px solid rgba(43,124,255,.55);
      background:rgba(43,124,255,.08);
      padding:10px 12px;
      border-radius:12px;
      margin:12px 0 16px;
    }

    figure.inline-media{margin:12px 0 16px; border:1px solid rgba(18,22,28,.10); border-radius:14px; overflow:hidden; background:#f8fafc;}
    figure.inline-media img{width:100%; height:auto; display:block; cursor:zoom-in;}
    figure.inline-media figcaption{font-family:var(--sans); font-size:12px; color:#394455; padding:8px 10px; border-top:1px solid rgba(18,22,28,.08); background:#fff;}

    /* POPUP (immagini) */
    .pop{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:min(920px,92vw);
      height:min(640px,80vh);
      z-index:80;
      display:none;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      overflow:hidden;
    }
    .pop.open{display:grid; grid-template-rows:auto 1fr;}
    .pop-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      background:rgba(0,0,0,.25);
      border-bottom:1px solid rgba(255,255,255,.12);
      cursor:grab; user-select:none;
    }
    .pop-top:active{cursor:grabbing;}
    .pop-title{font-family:var(--sans); font-size:13px; color:rgba(255,255,255,.92); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .pop-actions{display:flex; gap:8px; flex-wrap:wrap;}
    .iconbtn{border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#fff; border-radius:12px; padding:8px 10px; cursor:pointer; font-size:12px; user-select:none;}
    .iconbtn:hover{background:rgba(255,255,255,.12);}
    .pop-body{position:relative; overflow:hidden; background:rgba(255,255,255,.06);}
    .stage{position:absolute; inset:0; overflow:hidden; touch-action:none;}
    .pop-img{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%) scale(1);
      transform-origin:center;
      cursor:grab;
      max-width:none;
      width:1200px;
      height:auto;
      user-select:none;
      -webkit-user-drag:none;
      border-radius:14px;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      touch-action:none;
    }
    .pop-img:active{cursor:grabbing;}
    .resize-handle{position:absolute; right:8px; bottom:8px; width:18px; height:18px; border-radius:6px; background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.26); cursor:nwse-resize; touch-action:none;}

    /* POPUP (video) */
    .video-box{background:rgba(255,255,255,.06);}
    .video-box iframe{width:100%; aspect-ratio:16/9; border:0; display:block;}

    /* NOTE (facoltativo) */
    .notes{
      position:fixed; right:22px; bottom:22px;
      width:min(520px, calc(100vw - 44px));
      height:320px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      z-index:90;
      display:none;
      overflow:hidden;
    }
    .notes.open{display:grid; grid-template-rows:auto 1fr auto;}
    .notes-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      background:rgba(0,0,0,.25);
      border-bottom:1px solid rgba(255,255,255,.12);
      cursor:grab; user-select:none;
    }
    .notes-top:active{cursor:grabbing;}
    .notes-title strong{font-size:13px; color:rgba(255,255,255,.92); font-family:var(--sans);}
    .notes-body{padding:10px 12px; background:rgba(255,255,255,.06);}
    .notes-text{
      width:100%; height:100%; box-sizing:border-box; resize:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      color:rgba(255,255,255,.92);
      font-family:var(--mono);
      font-size:13px;
      line-height:1.45;
      padding:10px 12px;
      outline:none;
    }
    .notes-bottom{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      font-family:var(--sans);
      font-size:12px;
      color:rgba(255,255,255,.75);
    }

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr;}
      .sidebar{position:relative; top:0;}
      .pages.two{grid-template-columns:1fr;}
      input[type="range"]{width:140px;}
      .notes{right:14px; bottom:14px; width:calc(100vw - 28px);}
    }
  </style>
</head>

<body>
  <header>
    <div class="crumb">
      <!-- HOME VUOTO: lo decidi tu -->
      <a href="" title="Home (da definire)">Home</a>
      <span class="sep">‚Üí</span>
      <span style="font-weight:700;">Pirandello</span>
      <span class="sep">‚Üí</span>
      <span>Visione del mondo</span>
    </div>

    <div class="toolbar">
      <button class="btn" id="toggleTwo" aria-pressed="false">‚ÜîÔ∏é 2 pagine</button>
      <div class="pill" title="Dimensione del testo">A‚àí <input id="font" type="range" min="15" max="24" value="18" /> A+</div>
      <button class="btn" id="toggleNotes" aria-pressed="false">üìù Appunti</button>
      <button class="btn" id="openOptions" aria-pressed="false">‚öôÔ∏é Opzioni</button>
    </div>
  </header>

  <div class="wrap">
    <!-- COLONNA SINISTRA -->
    <aside class="sidebar">
      <div class="side-inner">
        <div class="author-card">
          <!-- CLIC = VIDEO -->
          <img class="author-img" id="authorThumb" src="assets/Pirandello-ritratto.png" alt="Pirandello (clicca per video)">
          <div class="author-meta">
            <strong>Luigi Pirandello</strong>
            <span>clicca la foto per aprire il video</span>
          </div>
        </div>

        <div class="side-title">Indice</div>
        <nav class="index" aria-label="Indice">
          <a href="#intro">Introduzione <small>(sezione)</small></a>
          <a href="#umorismo">1. Umorismo <small>(sezione)</small></a>
          <a href="#romanzi">2. Romanzi <small>(sezione)</small></a>
          <a href="#teatro">3. Teatro <small>(sezione)</small></a>
          <a href="#sintesi">4. Visione del mondo <small>(completa)</small></a>
        </nav>
      </div>
    </aside>

    <!-- COLONNA DESTRA -->
    <main class="pages" id="pages">
      <!-- PAGINA 1 -->
      <article class="page" id="page1">
        <div class="page-inner">
          <section id="intro">
            <h1>Introduzione</h1>
            <div class="meta">
              <span>Layout ‚Äúquaderno‚Äù: sinistra (foto+indice), destra (testo)</span>
              <span>Immagini nel testo (clic ‚Üí pop-up)</span>
              <span>Foto autore (clic ‚Üí HeyGen)</span>
            </div>
            <div class="note">Qui lasciamo volutamente ‚Äúvuoto‚Äù/placeholder: inserirai tu i contenuti quando vuoi.</div>
          </section>

          <section id="umorismo">
            <h2>1) La poetica dell‚Äôumorismo</h2>
            <div class="note">Testo da inserire.</div>
          </section>

          <section id="romanzi">
            <h2>2) I ROMANZI</h2>
            <h3>Il fu Mattia Pascal</h3>
            <div class="note">Testo da inserire.</div>
            <h3>Uno, nessuno e centomila</h3>
            <div class="note">Testo da inserire.</div>
          </section>

          <section id="teatro">
            <h2>3) IL TEATRO</h2>
            <h3>Cos√¨ √® (se vi pare)</h3>
            <div class="note">Testo da inserire.</div>
            <h3>Sei personaggi in cerca d‚Äôautore</h3>
            <div class="note">Testo da inserire.</div>
          </section>
        </div>
      </article>

      <!-- PAGINA 2 -->
      <article class="page" id="page2">
        <div class="page-inner">
          <section id="sintesi">
            <h1>La visione del mondo</h1>

            <p>Le opere di Pirandello si fondano su un presupposto filosofico: il vitalismo di Bergson. Secondo questa concezione, la vita √® un divenire incessante, un flusso continuo di trasformazioni. Ogni essere passa da uno stato all‚Äôaltro e chi tenta di sottrarsi a questo movimento perenne, fissandosi in una forma immobile, si condanna alla morte interiore.</p>
            <figure class="inline-media">
              <img class="thumb" src="assets/Filosofia-Pirandello.png" alt="Concezione filosofica" data-title="Concezione filosofica ‚Äî vitalismo e flusso">
              <figcaption>Concezione filosofica ‚Äî vitalismo e flusso</figcaption>
            </figure>

            <p>Da tale visione nasce uno dei temi centrali della sua opera: l‚Äôincomunicabilit√†. L‚Äôuomo europeo del primo Novecento vive in una societ√† complessa, artificiale e spesso estranea. Ha perduto le certezze legate al mondo contadino, fatto di ritmi naturali e di cose semplici che davano senso all‚Äôesistenza, sostituendole con un tempo e uno spazio innaturali, propri della modernit√†.</p>
            <figure class="inline-media">
              <img class="thumb" src="assets/Realta-Pirandello.png" alt="La realt√† √® multiforme" data-title="La realt√† √® multiforme ‚Üí incomunicabilit√†">
              <figcaption>La realt√† √® multiforme ‚Üí incomunicabilit√†</figcaption>
            </figure>

            <p>Pirandello estende la sua critica alle strutture portanti della civilt√† occidentale. La famiglia diventa luogo di incomunicabilit√† e rancori; il lavoro si riduce a meccanismo alienante che priva l‚Äôuomo della propria identit√†. Cos√¨, i pilastri della societ√† borghese si rivelano maschere collettive che nascondono il vuoto.</p>
            <figure class="inline-media">
              <img class="thumb" src="assets/Societa-Pirandello.png" alt="Pirandello e la societ√† borghese" data-title="Societ√† borghese: famiglia e lavoro come maschere">
              <figcaption>Societ√† borghese: famiglia e lavoro come maschere</figcaption>
            </figure>

            <p>L‚Äôindividuo si scopre frammentato: per gli altri √® centomila personalit√†, mentre per s√© stesso non √® che nessuno. Ogni tentativo di fissarsi in una forma diventa una nuova maschera. √à questo il destino comune: uscire dal grigiore quotidiano per scoprire di essere esclusi ‚Äî condannati a restare ‚Äúnessuno‚Äù.</p>
            <figure class="inline-media">
              <img class="thumb" src="assets/Conseguenze-Pirandello.png" alt="Conseguenze dell‚Äôincomunicabilit√†" data-title="Conseguenze: solitudine e scoperta del ‚Äònessuno‚Äô">
              <figcaption>Conseguenze: solitudine e scoperta del ‚Äúnessuno‚Äù</figcaption>
            </figure>

            <figure class="inline-media">
              <img class="thumb" src="assets/Mondo-Pirandello.png" alt="Schema: visione del mondo" data-title="Schema: la visione del mondo (mappa)">
              <figcaption>Schema: la visione del mondo (mappa)</figcaption>
            </figure>
          </section>
        </div>
      </article>
    </main>
  </div>

  <!-- POPUP IMMAGINI -->
  <div class="pop" id="imgPop" role="dialog" aria-modal="true" aria-label="Immagine">
    <div class="pop-top" id="popDrag">
      <div class="pop-title" id="popTitle">Immagine</div>
      <div class="pop-actions">
        <button class="iconbtn" id="popZoomOut">‚àí</button>
        <button class="iconbtn" id="popZoomIn">+</button>
        <button class="iconbtn" id="popReset">Reset</button>
        <button class="iconbtn" id="popClose">Chiudi</button>
      </div>
    </div>
    <div class="pop-body">
      <div class="stage" id="popStage">
        <img id="popImg" class="pop-img" alt="Immagine zoomabile" />
      </div>
      <div class="resize-handle" id="popResize" title="Ridimensiona"></div>
    </div>
  </div>

  <!-- POPUP VIDEO -->
  <div class="pop" id="videoPop" role="dialog" aria-modal="true" aria-label="Video autore">
    <div class="pop-top" id="videoDrag">
      <div class="pop-title">Video ‚Äî Pirandello</div>
      <div class="pop-actions">
        <button class="iconbtn" id="videoClose">Chiudi</button>
      </div>
    </div>
    <div class="video-box" id="videoBox"></div>
  </div>

  <!-- APPUNTI -->
  <section class="notes" id="notesWin" aria-label="Finestra appunti">
    <div class="notes-top" id="notesDrag">
      <div class="notes-title"><strong>Appunti</strong></div>
      <div class="pop-actions">
        <button class="iconbtn" id="exportTxt">Export .txt</button>
        <button class="iconbtn" id="clearNotes">Svuota</button>
        <button class="iconbtn" id="closeNotes">Chiudi</button>
      </div>
    </div>
    <div class="notes-body">
      <textarea class="notes-text" id="notesText" placeholder="Scrivi qui i tuoi appunti‚Ä¶ (si salvano da soli)"></textarea>
    </div>
    <div class="notes-bottom">
      <div id="status">Pronto</div>
      <div id="counter">0 caratteri</div>
    </div>
  </section>

  <script>
    // Scorrimento indice
    document.querySelectorAll('.index a').forEach(a=>{
      a.addEventListener('click',(e)=>{
        const href=a.getAttribute('href');
        if(!href || !href.startsWith('#')) return;
        const target=document.querySelector(href);
        if(!target) return;
        e.preventDefault();
        target.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // Toggle 2 pagine
    const pages=document.getElementById('pages');
    const toggleTwo=document.getElementById('toggleTwo');
    let twoPages=false;
    toggleTwo.addEventListener('click',()=>{
      twoPages=!twoPages;
      pages.classList.toggle('two', twoPages);
      toggleTwo.setAttribute('aria-pressed', String(twoPages));
      toggleTwo.textContent = twoPages ? '‚ÜîÔ∏é 1 pagina' : '‚ÜîÔ∏é 2 pagine';
    });

    // Font size
    const font=document.getElementById('font');
    font.addEventListener('input',()=>{
      const px=Number(font.value);
      document.querySelectorAll('.page-inner').forEach(el=>el.style.fontSize=px+'px');
    });

    // POPUP immagini (drag + resize + zoom + pan)
    const imgPop=document.getElementById('imgPop');
    const popDrag=document.getElementById('popDrag');
    const popResize=document.getElementById('popResize');
    const popTitle=document.getElementById('popTitle');
    const popImg=document.getElementById('popImg');
    const popStage=document.getElementById('popStage');
    const popClose=document.getElementById('popClose');
    const popReset=document.getElementById('popReset');
    const popZoomIn=document.getElementById('popZoomIn');
    const popZoomOut=document.getElementById('popZoomOut');

    let pscale=1, ptx=0, pty=0;
    let pdrag={active:false, startX:0, startY:0, startLeft:0, startTop:0};
    let presize={active:false, startX:0, startY:0, startW:0, startH:0};
    let imgPan={active:false, startX:0, startY:0, startTx:0, startTy:0};

    const clamp=(n,min,max)=>Math.max(min, Math.min(max,n));
    const applyPopTransform=()=> {
      popImg.style.transform = `translate(calc(-50% + ${ptx}px), calc(-50% + ${pty}px)) scale(${pscale})`;
    };

    function openImagePop(src,title){
      popImg.src=src;
      popTitle.textContent=title || 'Immagine';
      pscale=1; ptx=0; pty=0; applyPopTransform();

      imgPop.style.width='min(920px, 92vw)';
      imgPop.style.height='min(640px, 80vh)';
      imgPop.style.left='50%';
      imgPop.style.top='50%';
      imgPop.style.transform='translate(-50%,-50%)';
      imgPop.classList.add('open');
      popClose.focus();
    }
    function closeImagePop(){
      imgPop.classList.remove('open');
      imgPan.active=false; pdrag.active=false; presize.active=false;
    }

    document.querySelectorAll('img.thumb').forEach(img=>{
      img.addEventListener('click', ()=>openImagePop(img.src, img.dataset.title || img.alt || 'Immagine'));
    });

    popClose.addEventListener('click', closeImagePop);
    popReset.addEventListener('click', ()=>{pscale=1; ptx=0; pty=0; applyPopTransform();});
    popZoomIn.addEventListener('click', ()=>{pscale=Math.min(6, +(pscale+0.2).toFixed(2)); applyPopTransform();});
    popZoomOut.addEventListener('click', ()=>{pscale=Math.max(0.6, +(pscale-0.2).toFixed(2)); applyPopTransform();});

    popStage.addEventListener('wheel',(e)=>{
      if(!imgPop.classList.contains('open')) return;
      e.preventDefault();
      const d=Math.sign(e.deltaY);
      pscale = d>0 ? Math.max(0.6, +(pscale-0.12).toFixed(2)) : Math.min(6, +(pscale+0.12).toFixed(2));
      applyPopTransform();
    }, {passive:false});

    popImg.addEventListener('pointerdown',(e)=>{
      imgPan.active=true;
      imgPan.startX=e.clientX; imgPan.startY=e.clientY;
      imgPan.startTx=ptx; imgPan.startTy=pty;
      popImg.setPointerCapture(e.pointerId);
    });
    popImg.addEventListener('pointermove',(e)=>{
      if(!imgPan.active) return;
      const dx=e.clientX-imgPan.startX, dy=e.clientY-imgPan.startY;
      ptx=imgPan.startTx+dx; pty=imgPan.startTy+dy;
      applyPopTransform();
    });
    popImg.addEventListener('pointerup',()=>imgPan.active=false);
    popImg.addEventListener('pointercancel',()=>imgPan.active=false);

    popDrag.addEventListener('pointerdown',(e)=>{
      pdrag.active=true;
      popDrag.setPointerCapture(e.pointerId);
      const r=imgPop.getBoundingClientRect();
      pdrag.startX=e.clientX; pdrag.startY=e.clientY;
      pdrag.startLeft=r.left; pdrag.startTop=r.top;
      imgPop.style.left=r.left+'px';
      imgPop.style.top=r.top+'px';
      imgPop.style.transform='none';
    });
    popDrag.addEventListener('pointermove',(e)=>{
      if(!pdrag.active) return;
      const dx=e.clientX-pdrag.startX, dy=e.clientY-pdrag.startY;
      const r=imgPop.getBoundingClientRect(), w=r.width, h=r.height;
      imgPop.style.left = clamp(pdrag.startLeft+dx, 8, window.innerWidth-w-8) + 'px';
      imgPop.style.top  = clamp(pdrag.startTop +dy, 8, window.innerHeight-h-8) + 'px';
    });
    popDrag.addEventListener('pointerup',()=>pdrag.active=false);
    popDrag.addEventListener('pointercancel',()=>pdrag.active=false);

    popResize.addEventListener('pointerdown',(e)=>{
      presize.active=true;
      popResize.setPointerCapture(e.pointerId);
      const r=imgPop.getBoundingClientRect();
      presize.startX=e.clientX; presize.startY=e.clientY;
      presize.startW=r.width; presize.startH=r.height;
    });
    popResize.addEventListener('pointermove',(e)=>{
      if(!presize.active) return;
      const dx=e.clientX-presize.startX, dy=e.clientY-presize.startY;
      imgPop.style.width  = clamp(presize.startW+dx, 320, window.innerWidth-16) + 'px';
      imgPop.style.height = clamp(presize.startH+dy, 240, window.innerHeight-16) + 'px';
    });
    popResize.addEventListener('pointerup',()=>presize.active=false);
    popResize.addEventListener('pointercancel',()=>presize.active=false);

    // VIDEO (HeyGen) ‚Äî tuo iframe ESATTO
    const authorThumb=document.getElementById('authorThumb');
    const videoPop=document.getElementById('videoPop');
    const videoDrag=document.getElementById('videoDrag');
    const videoClose=document.getElementById('videoClose');
    const videoBox=document.getElementById('videoBox');

    const HEYGEN_EMBED = `<iframe width="560" height="315" src="https://app.heygen.com/embedded-player/70ac565e14cd4e8b83052dc76434961e" title="HeyGen video player" frameborder="0" allow="encrypted-media; fullscreen;" allowfullscreen></iframe>`;

    function openVideo(){
      videoBox.innerHTML = HEYGEN_EMBED;
      const iframe = videoBox.querySelector('iframe');
      if(iframe){
        iframe.removeAttribute('width');
        iframe.removeAttribute('height');
        iframe.style.width='100%';
        iframe.style.aspectRatio='16 / 9';
        iframe.style.display='block';
      }
      videoPop.classList.add('open');
      videoClose.focus();
    }
    function closeVideo(){
      videoPop.classList.remove('open');
      videoBox.innerHTML='';
    }
    authorThumb.addEventListener('click', openVideo);
    videoClose.addEventListener('click', closeVideo);

    let vdrag={active:false, startX:0, startY:0, startLeft:0, startTop:0};
    videoDrag.addEventListener('pointerdown',(e)=>{
      vdrag.active=true;
      videoDrag.setPointerCapture(e.pointerId);
      const r=videoPop.getBoundingClientRect();
      vdrag.startX=e.clientX; vdrag.startY=e.clientY;
      vdrag.startLeft=r.left; vdrag.startTop=r.top;
      videoPop.style.left=r.left+'px';
      videoPop.style.top=r.top+'px';
      videoPop.style.transform='none';
    });
    videoDrag.addEventListener('pointermove',(e)=>{
      if(!vdrag.active) return;
      const dx=e.clientX-vdrag.startX, dy=e.clientY-vdrag.startY;
      const r=videoPop.getBoundingClientRect(), w=r.width, h=r.height;
      videoPop.style.left = clamp(vdrag.startLeft+dx, 8, window.innerWidth-w-8) + 'px';
      videoPop.style.top  = clamp(vdrag.startTop +dy, 8, window.innerHeight-h-8) + 'px';
    });
    videoDrag.addEventListener('pointerup',()=>vdrag.active=false);
    videoDrag.addEventListener('pointercancel',()=>vdrag.active=false);

    // APPUNTI (autosave)
    const toggleNotes=document.getElementById('toggleNotes');
    const notesWin=document.getElementById('notesWin');
    const notesDrag=document.getElementById('notesDrag');
    const notesText=document.getElementById('notesText');
    const closeNotes=document.getElementById('closeNotes');
    const exportTxt=document.getElementById('exportTxt');
    const clearNotes=document.getElementById('clearNotes');
    const statusEl=document.getElementById('status');
    const counter=document.getElementById('counter');

    const NOTES_KEY = `mw_notes::${location.pathname}`;
    const POS_KEY = `mw_notes_pos::${location.pathname}`;

    function openNotes(){ notesWin.classList.add('open'); toggleNotes.setAttribute('aria-pressed','true'); notesText.focus(); }
    function closeNotesWin(){ notesWin.classList.remove('open'); toggleNotes.setAttribute('aria-pressed','false'); }
    toggleNotes.addEventListener('click', ()=> notesWin.classList.contains('open') ? closeNotesWin() : openNotes());
    closeNotes.addEventListener('click', closeNotesWin);

    const saved=localStorage.getItem(NOTES_KEY);
    if(saved!==null) notesText.value=saved;

    function updateCounter(){ counter.textContent = `${notesText.value.length} caratteri`; }
    updateCounter();

    let saveTimer=null;
    notesText.addEventListener('input', ()=>{
      updateCounter();
      statusEl.textContent='Scrivendo‚Ä¶';
      clearTimeout(saveTimer);
      saveTimer=setTimeout(()=>{
        localStorage.setItem(NOTES_KEY, notesText.value);
        statusEl.textContent='Salvati';
      }, 350);
    });

    exportTxt.addEventListener('click', ()=>{
      const blob=new Blob([notesText.value], {type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');
      const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=URL.createObjectURL(blob);
      a.download=`Pirandello-appunti-${stamp}.txt`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    });

    clearNotes.addEventListener('click', ()=>{
      notesText.value='';
      updateCounter();
      localStorage.setItem(NOTES_KEY,'');
      statusEl.textContent='Svuotati';
      notesText.focus();
    });

    // notes drag position (persist)
    const savedPos=localStorage.getItem(POS_KEY);
    if(savedPos){
      try{
        const p=JSON.parse(savedPos);
        if(typeof p.left==='number') notesWin.style.left=p.left+'px';
        if(typeof p.top==='number') notesWin.style.top=p.top+'px';
        notesWin.style.right='auto'; notesWin.style.bottom='auto';
      }catch{}
    }
    let ndrag={active:false, startX:0, startY:0, startLeft:0, startTop:0};
    notesDrag.addEventListener('pointerdown',(e)=>{
      ndrag.active=true;
      notesDrag.setPointerCapture(e.pointerId);
      const r=notesWin.getBoundingClientRect();
      ndrag.startX=e.clientX; ndrag.startY=e.clientY;
      ndrag.startLeft=r.left; ndrag.startTop=r.top;
      notesWin.style.left=r.left+'px';
      notesWin.style.top=r.top+'px';
      notesWin.style.right='auto'; notesWin.style.bottom='auto';
    });
    notesDrag.addEventListener('pointermove',(e)=>{
      if(!ndrag.active) return;
      const dx=e.clientX-ndrag.startX, dy=e.clientY-ndrag.startY;
      const r=notesWin.getBoundingClientRect(), w=r.width, h=r.height;
      notesWin.style.left = clamp(ndrag.startLeft+dx, 8, window.innerWidth-w-8) + 'px';
      notesWin.style.top  = clamp(ndrag.startTop +dy, 8, window.innerHeight-h-8) + 'px';
    });
    notesDrag.addEventListener('pointerup', ()=>{
      if(!ndrag.active) return;
      ndrag.active=false;
      const r=notesWin.getBoundingClientRect();
      localStorage.setItem(POS_KEY, JSON.stringify({left:r.left, top:r.top}));
    });
    notesDrag.addEventListener('pointercancel', ()=>ndrag.active=false);

    // ESC chiude popup
    window.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        if(imgPop.classList.contains('open')) closeImagePop();
        if(videoPop.classList.contains('open')) closeVideo();
      }
    });

    // opzioni
    document.getElementById('openOptions').addEventListener('click', ()=>{
      alert("Opzioni:\n- 2 pagine: divide la colonna destra\n- Appunti: finestra flottante (autosave)\n- Foto autore: apre HeyGen\n\nHome √® volutamente vuoto (lo imposti tu).");
    });
  </script>
</body>
</html>
